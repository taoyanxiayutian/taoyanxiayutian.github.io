<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>è“ç™½æ‹¼å›¾æ¸¸æˆ - å®Œæˆç‰ˆ</title>
<style>
body {
  margin: 0;
  font-family: "Segoe UI", "å¾®è½¯é›…é»‘", sans-serif;
  background: linear-gradient(135deg, #cce5ff, #e8f0ff);
  color: #1e3a8a;
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
}
.game-container {
  display: flex;
  background: white;
  border-radius: 20px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.15);
  overflow: hidden;
  width: 90%;
  max-width: 1200px;
  height: 90vh;
  padding: 20px;
  gap: 20px;
}
.left-panel, .right-panel {
  flex: 1;
  border-radius: 15px;
  background: #f5f9ff;
  display: flex;
  flex-direction: column;
  align-items: center;
  box-shadow: inset 0 0 10px rgba(0,0,0,0.05);
  padding: 10px;
}
h2 { margin: 10px 0; }

.puzzle-board, .pieces-container {
  width: 90%;
  aspect-ratio: 1/1;
  background: #ebf4ff;
  border: 3px solid #90cdf4;
  border-radius: 15px;
  display: grid;
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}
.puzzle-slot {
  border: 1px dashed #dbeafe;
  background-color: #f8fafc;
  border-radius: 6px;
  position: relative;
  overflow: hidden;
}
.pieces-container {
  overflow-y: auto;
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  align-items: center;
  padding: 5px;
}
.puzzle-piece {
  border: 1px solid #dbeafe;
  border-radius: 5px;
  background-size: cover;
  background-position: center;
  cursor: grab;
  transition: transform 0.2s ease;
}
.puzzle-piece:active { transform: scale(1.05); cursor: grabbing; }

button, select {
  background: #3b82f6;
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 10px;
  cursor: pointer;
  font-size: 0.9rem;
  transition: background 0.2s;
}
button:hover { background: #2563eb; }
select { background: #60a5fa; }
.controls, .right-controls {
  display: flex;
  gap: 10px;
  margin: 10px 0;
}

/* âœ‚ï¸ è£å‰ªå±‚ */
#cropArea {
  display: none;
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.8);
  justify-content: center;
  align-items: center;
  z-index: 3000;
  flex-direction: column;
}
#cropContainer {
  position: relative;
  display: inline-block;
}
#cropImage {
  max-width: 80vw;
  max-height: 80vh;
  border-radius: 10px;
  display: block;
}
.crop-overlay {
  position: absolute;
  top: 0; left: 0;
  width: 100%; height: 100%;
  cursor: crosshair;
}
#cropBox {
  position: absolute;
  border: 2px solid #3b82f6;
  background: rgba(59,130,246,0.2);
  display: none;
}
#cropButtons {
  margin-top: 15px;
  display: flex;
  gap: 15px;
}
#cropButtons button {
  background: #06b6d4;
}

/* ğŸ‘ï¸ åŸå›¾å¼¹çª— */
#previewModal {
  display: none;
  position: fixed;
  top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  background: white;
  border-radius: 15px;
  box-shadow: 0 8px 30px rgba(0,0,0,0.25);
  z-index: 4000;
  padding: 20px;
  text-align: center;
}
#previewModal img {
  max-width: 70vw;
  max-height: 70vh;
  border-radius: 10px;
}
#closePreview {
  margin-top: 10px;
  background: #3b82f6;
}

/* ğŸ‰ å®Œæˆå¼¹çª— */
#successBox {
  display: none;
  position: fixed;
  top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  background: white;
  border-radius: 20px;
  box-shadow: 0 8px 30px rgba(0,0,0,0.3);
  text-align: center;
  z-index: 5000;
  padding: 25px 40px;
  animation: fadeIn 0.6s ease;
}
#successBox h3 {
  font-size: 1.6em;
  color: #2563eb;
  margin-bottom: 10px;
}
#successBox p {
  font-size: 1rem;
  color: #1e3a8a;
}
@keyframes fadeIn {
  from { opacity: 0; transform: translate(-50%, -60%); }
  to { opacity: 1; transform: translate(-50%, -50%); }
}

/* ğŸŠ å½©å¸¦ */
.confetti {
  position: fixed;
  width: 8px;
  height: 8px;
  opacity: 0.8;
  z-index: 4999;
  pointer-events: none;
}
</style>
</head>
<body>
<div class="game-container">
  <div class="left-panel">
    <h2>æ‹¼å›¾åŒº</h2>
    <div class="controls">
      <input type="file" id="imageUpload" accept="image/*" style="display:none">
      <button id="uploadBtn">ä¸Šä¼ å›¾ç‰‡</button>
      <select id="difficulty">
        <option value="3">ç®€å•(3Ã—3)</option>
        <option value="4">ä¸­ç­‰(4Ã—4)</option>
        <option value="5">å›°éš¾(5Ã—5)</option>
      </select>
      <button id="resetBtn">é‡ç½®</button>
    </div>
    <div class="puzzle-board" id="puzzleBoard"></div>
  </div>

  <div class="right-panel">
    <h2>æ‹¼å›¾ç¢ç‰‡</h2>
    <div class="right-controls">
      <button id="resetAllBtn">å…¨éƒ¨é‡ç½®</button>
      <button id="previewBtn">æŸ¥çœ‹åŸå›¾</button>
    </div>
    <div class="pieces-container" id="piecesContainer"></div>
    <div style="margin-top:10px;font-size:0.9rem;">
      â±ï¸ ç”¨æ—¶ï¼š<span id="timeCounter">00:00</span>ã€€ğŸ”¢ æ­¥æ•°ï¼š<span id="stepCounter">0</span>
    </div>
  </div>
</div>

<!-- âœ‚ï¸ è£å‰ªåŒºåŸŸ -->
<div id="cropArea">
  <div id="cropContainer">
    <img id="cropImage" />
    <div class="crop-overlay" id="cropOverlay"></div>
    <div id="cropBox"></div>
  </div>
  <div id="cropButtons">
    <button id="confirmCrop">ç¡®è®¤é€‰åŒº</button>
    <button id="cancelCrop">é‡æ–°é€‰æ‹©</button>
  </div>
</div>

<!-- ğŸ‘ï¸ åŸå›¾å¼¹çª— -->
<div id="previewModal">
  <img id="previewImg" alt="åŸå›¾é¢„è§ˆ" />
  <div><button id="closePreview">å…³é—­é¢„è§ˆ</button></div>
</div>

<!-- ğŸ‰ å®Œæˆå¼¹çª— -->
<div id="successBox">
  <h3>ğŸ‰ æ‹¼å›¾å®Œæˆï¼</h3>
  <p id="resultText"></p>
  <button onclick="closeSuccess()">ç»§ç»­æ¸¸æˆ</button>
</div>

<script>
let img=null, size=3, pieces=[], originalImgURL="";
let cropData=null, scaleFactor=1;
let startTime=null, timer=null, steps=0;

const cropArea=document.getElementById('cropArea');
const cropImage=document.getElementById('cropImage');
const cropOverlay=document.getElementById('cropOverlay');
const cropBox=document.getElementById('cropBox');
const puzzleBoard=document.getElementById('puzzleBoard');
const piecesContainer=document.getElementById('piecesContainer');
const previewModal=document.getElementById('previewModal');
const previewImg=document.getElementById('previewImg');
const timeCounter=document.getElementById('timeCounter');
const stepCounter=document.getElementById('stepCounter');

document.getElementById('uploadBtn').onclick=()=>document.getElementById('imageUpload').click();
document.getElementById('imageUpload').onchange=e=>{
  const file=e.target.files[0];
  if(!file)return;
  const url=URL.createObjectURL(file);
  originalImgURL=url;
  cropImage.src=url;
  cropArea.style.display='flex';
  cropBox.style.display='none';
  cropData=null;
};

cropImage.onload=()=>{
  const displayW=cropImage.getBoundingClientRect().width;
  scaleFactor=cropImage.naturalWidth/displayW;
};

let startX,startY,isDrawing=false;
cropOverlay.onmousedown=e=>{
  const rect=cropImage.getBoundingClientRect();
  startX=e.clientX-rect.left;
  startY=e.clientY-rect.top;
  isDrawing=true;
};
cropOverlay.onmousemove=e=>{
  if(!isDrawing)return;
  const rect=cropImage.getBoundingClientRect();
  const endX=e.clientX-rect.left;
  const endY=e.clientY-rect.top;
  const side=Math.min(Math.abs(endX-startX),Math.abs(endY-startY));
  const x=endX<startX?startX-side:startX;
  const y=endY<startY?startY-side:startY;
  cropBox.style.display='block';
  cropBox.style.left=x+'px';
  cropBox.style.top=y+'px';
  cropBox.style.width=side+'px';
  cropBox.style.height=side+'px';
};
cropOverlay.onmouseup=()=>{
  isDrawing=false;
  const bx=parseFloat(cropBox.style.left);
  const by=parseFloat(cropBox.style.top);
  const bsize=parseFloat(cropBox.style.width);
  cropData={x:bx*scaleFactor,y:by*scaleFactor,size:bsize*scaleFactor};
};

document.getElementById('confirmCrop').onclick=()=>{
  if(!cropData){alert("è¯·å…ˆé€‰æ‹©åŒºåŸŸ");return;}
  const canvas=document.createElement('canvas');
  canvas.width=cropData.size;
  canvas.height=cropData.size;
  const ctx=canvas.getContext('2d');
  const temp=new Image(); temp.src=originalImgURL;
  temp.onload=()=>{
    ctx.drawImage(temp,cropData.x,cropData.y,cropData.size,cropData.size,0,0,cropData.size,cropData.size);
    const cropped=new Image();
    cropped.onload=()=>{cropArea.style.display='none';createPuzzle(cropped);}
    cropped.src=canvas.toDataURL();
    previewImg.src=canvas.toDataURL();
  };
};
document.getElementById('cancelCrop').onclick=()=>{cropBox.style.display='none';cropData=null;};

document.getElementById('difficulty').onchange=e=>{
  size=parseInt(e.target.value);
  if(img)createPuzzle(img);
};
document.getElementById('resetBtn').onclick=()=>{if(img)createPuzzle(img);}
document.getElementById('resetAllBtn').onclick=()=>location.reload();
document.getElementById('previewBtn').onclick=()=>previewModal.style.display='block';
document.getElementById('closePreview').onclick=()=>previewModal.style.display='none';

function createPuzzle(image){
  img=image;
  puzzleBoard.innerHTML=''; piecesContainer.innerHTML=''; pieces=[];
  puzzleBoard.style.gridTemplateColumns=`repeat(${size},1fr)`;
  puzzleBoard.style.gridTemplateRows=`repeat(${size},1fr)`;

  const pieceW=image.width/size;
  const pieceH=image.height/size;

  const boardRect=puzzleBoard.getBoundingClientRect();
  const displayPieceSize=boardRect.width/size-6;
  const c=document.createElement('canvas'),ctx=c.getContext('2d');
  c.width=image.width; c.height=image.height; ctx.drawImage(image,0,0);

  for(let r=0;r<size;r++)for(let c_=0;c_<size;c_++){
    const pcan=document.createElement('canvas');
    pcan.width=pieceW; pcan.height=pieceH;
    pcan.getContext('2d').drawImage(c,c_*pieceW,r*pieceH,pieceW,pieceH,0,0,pieceW,pieceH);
    const piece=document.createElement('div');
    piece.className='puzzle-piece';
    piece.style.backgroundImage=`url(${pcan.toDataURL()})`;
    piece.style.width=displayPieceSize+'px';
    piece.style.height=displayPieceSize+'px';
    piece.dataset.r=r; piece.dataset.c=c_;
    piece.draggable=true;
    piece.ondragstart=e=>{e.dataTransfer.setData('i',pieces.indexOf(piece));piece.style.opacity='0.5';};
    piece.ondragend=e=>piece.style.opacity='1';
    pieces.push(piece);
  }
  shuffle(pieces).forEach(p=>piecesContainer.appendChild(p));

  for(let i=0;i<size*size;i++){
    const s=document.createElement('div');
    s.className='puzzle-slot';
    s.style.width=displayPieceSize+'px';
    s.style.height=displayPieceSize+'px';
    s.ondragover=e=>e.preventDefault();
    s.ondrop=e=>{
      e.preventDefault();
      const i=e.dataTransfer.getData('i');
      const p=pieces[i];
      if(!s.hasChildNodes()){
        s.appendChild(p);
        steps++;
        stepCounter.textContent=steps;
        checkCompletion();
      }
    };
    puzzleBoard.appendChild(s);
  }

  piecesContainer.ondragover=e=>e.preventDefault();
  piecesContainer.ondrop=e=>{
    e.preventDefault();
    const i=e.dataTransfer.getData('i');
    piecesContainer.appendChild(pieces[i]);
  };

  startTimer();
}

function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}

function startTimer(){
  clearInterval(timer);
  steps=0;
  stepCounter.textContent='0';
  let elapsed=0;
  startTime=new Date();
  timer=setInterval(()=>{
    const now=new Date();
    elapsed=Math.floor((now-startTime)/1000);
    const min=String(Math.floor(elapsed/60)).padStart(2,'0');
    const sec=String(elapsed%60).padStart(2,'0');
    timeCounter.textContent=`${min}:${sec}`;
  },1000);
}

function stopTimer(){
  clearInterval(timer);
}

function checkCompletion(){
  const slots=puzzleBoard.querySelectorAll('.puzzle-slot');
  const allFilled=Array.from(slots).every(s=>s.hasChildNodes());
  if(!allFilled) return;

  let ok=true;
  slots.forEach((slot,i)=>{
    const p=slot.firstChild;
    const r=Math.floor(i/size),c=i%size;
    if(!p || parseInt(p.dataset.r)!==r || parseInt(p.dataset.c)!==c) ok=false;
  });

  if(ok) {
    stopTimer();
    showSuccess();
  }
}

function showSuccess(){
  const result=document.getElementById('resultText');
  result.textContent=`ç”¨æ—¶ï¼š${timeCounter.textContent}ã€€æ­¥æ•°ï¼š${steps}`;
  document.getElementById('successBox').style.display='block';
  createConfetti();
}

function closeSuccess(){
  document.getElementById('successBox').style.display='none';
}

function createConfetti(){
  const colors=['#3b82f6','#60a5fa','#93c5fd','#bfdbfe','#e0f2fe'];
  for(let i=0;i<60;i++){
    const c=document.createElement('div');
    c.className='confetti';
    c.style.left=Math.random()*100+'vw';
    c.style.top='-10px';
    c.style.backgroundColor=colors[Math.floor(Math.random()*colors.length)];
    c.style.width=c.style.height=(Math.random()*8+4)+'px';
    document.body.appendChild(c);
    const anim=c.animate([{transform:'translateY(0)'},{transform:`translateY(${Math.random()*100+50}vh) rotate(${Math.random()*360}deg)`}],
      {duration:Math.random()*3000+2000,easing:'ease-out'});
    anim.onfinish=()=>c.remove();
  }
}
</script>
</body>
</html>
